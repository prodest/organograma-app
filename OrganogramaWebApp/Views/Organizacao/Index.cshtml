@model IEnumerable<OrganogramaApp.Apresentacao.ViewModel.OrganizacaoListagemViewModel>

@{
    ViewBag.Title = "Organizações";
    ViewBag.SubTitle = "Lista de Organizações";
}

<section class="content-header">
    <h1>
        @ViewBag.Title
    </h1>
    <ol class="breadcrumb">
        <li><a href="#"><i class="fa fa-dashboard"></i> MENU PRINCIPAL</a></li>
        <li class="active">@ViewBag.Title</li>
    </ol>
</section>
<!-- Main content -->
<section id="content" class="content">
    <div class="row">
        <div class="col-lg-12" id="listaOrganizacoes">

            <div class="box box-info">
                <!-- /.box-header -->
                <div class="box-header with-border">
                    <h3 class="box-title">@ViewBag.SubTitle</h3>

                    <div class="pull-right box-tools">
                        <a href="@Url.Action("Cadastrar","Organizacao")" class="btn btn-info btn-sm" data-toggle="tooltip" title="Cadastrar Organização.">
                            <i class="fa fa-plus"></i> Novo
                        </a>
                    </div>
                </div>
                <!-- /.box-header -->
                <div class="box-body table-responsive">
                    <table id="tabelaUnidades" class="table table-condensed table-striped table-bordered">
                        <thead>
                            <tr>
                                <th class="col-xs-2">@Html.DisplayNameFor(model => model.Sigla)</th>
                                <th class="col-xs-8">@Html.DisplayNameFor(model => model.RazaoSocial)</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Model)
                            {
                                <tr>
                                    <td>
                                        @Html.DisplayFor(modelItem => item.Sigla)
                                    </td>
                                    <td>
                                        @Html.DisplayFor(modelItem => item.RazaoSocial)
                                    </td>
                                    <td>
                                        @*<a href="@Url.Action("Editar","Unidade",new { guid = item.Guid })" data-evento="2" class="btn btn-xs btn-primary btnModalUnidade" data-toggle="tooltip" title="Editar Unidade"><i class="fa fa-edit" aria-hidden="true"></i></a>*@
                                        <a href="@Url.Action("Consultar","Organizacao",new { guid = item.Guid })" data-evento="1" class="btn btn-xs btn-success btnModalUnidade" data-toggle="tooltip" title="Visualizar Organização"><i class="fa fa-eye" aria-hidden="true"></i></a>
                                        <a href="@Url.Action("Organograma","Home",new { guid = item.Guid })" data-evento="4" class="btn btn-xs btn-warning btnModalUnidade" data-toggle="tooltip" title="Visualizar Organograma"><i class="fa fa-sitemap" aria-hidden="true"></i></a>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>
</section>

@section styles {
    <link href="~/Scripts/OrgChart/jquery.orgchart.css" rel="stylesheet" type="text/css" />
    <link href="~/Scripts/OrgChart/orgchartCustom.css" rel="stylesheet" type="text/css" />
}

@section scripts{
    <script src="~/Scripts/OrgChart/jquery.orgchart.js"></script>
    <script src="~/Scripts/jsPDF/jspdf.min.js"></script>

    <script>
        $('body').on('click', '.btnModalUnidade', function () {
            var evento = "";

            if ($(this).attr('title') != "") {
                evento = $(this).attr('title')
            }
            else {
                evento = $(this).attr('data-original-title')
            }

            idEvento = $(this).attr('data-evento');


            $.ajax(this.href)
              .done(function (dados) {
                  if (dados != null) {
                      $('#modalTipoUnidadeLabel').text(evento);
                      $('#update').empty();

                      if (idEvento == 4) {
                          $('#update').append('<div class="organogramachart"></div>')
                          organograma('.organogramachart', dados);
                      }
                      else {
                          $('#update').append('<div class="detalhes"></div>')
                          $('.detalhes').append(dados);
                      }

                      $('#modalCriar').modal('show');
                  }
              })
              .fail(function () {
                  toastr["warning"]("Não foi possível monstar o organograma solicitado!");
              });

            return false;
        });

        var organograma = function exibeOrganograma(divContent, dados) {
            $(divContent).orgchart({
                'data': dados,
                'depth': 2,
                'nodeContent': 'title',
                //'exportButton': true,
                //'exportFilename': 'Organograma',
                //'exportFileextension': 'pdf',
                'pan': true,
                'zoom': true,
                'nodeID': 'tipo',
                'toggleSiblingsResp': true,
                'parentNodeSymbol': 'fa-sitemap',
                'createNode': function ($node, data) {
                    var secondMenuIcon = $('<i>', {
                        'class': 'second-menu-icon',
                        click: function () {
                            ExibeDetalhes(data.className, data.guid);
                            //$(this).siblings('.second-menu').toggle();
                        }
                    });
                    var secondMenu = '<div class="second-menu"><p>' + data.tipo + '</p></div>';
                    $node.append(secondMenuIcon).append(secondMenu);
                }
            });
        }


        function ExibeDetalhes(tipo, guid) {
            var url = "";

            if (guid != '' && tipo == 'unidade') {
                url = '/Unidade/Visualizar?guid=' + guid;
            }
            else if (guid != '' && tipo == 'organizacao') {
                url = '/Organizacao/Consultar?guid=' + guid;
            }
            else {
                return false;
            }

            $.ajax(url)
              .done(function (dados) {
                  if (dados != null) {
                      $('#update').append('<div class="detalhes"></div>')
                      
                      $('.organogramachart').hide();
                      $('.detalhes').append(dados);
                      $('.detalhes').append('<div id="resultForm" class="form-group text-right"><button type="button" id="btn-voltar" class="btn btn-primary"><i class="fa fa-long-arrow-left" aria-hidden="true"></i> Voltar</button></div>');
                  }
              })
              .fail(function () {
                  toastr["warning"]("Não foi possível monstar o organograma solicitado!");
              });
        }

        $('body').on('click', '#btn-voltar', function () {
            $('.organogramachart').show();
            $('.detalhes').hide();
        });

    </script>
}