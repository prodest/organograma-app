@{
    ViewBag.Title = "Index";
    ViewBag.Title = "Home";
    Layout = "~/Views/Shared/_LayoutPublico.cshtml";
}

@model IEnumerable<OrganogramaApp.Apresentacao.ViewModel.OrganizacaoDropDownList>

    <div class="jumbotron sep-bg-jumbotron">
        <div class="container">
            <h1>Organograma</h1>
            <p>É um sistema corporativo, que visa a manutenção das informações organizacionais dos órgão do Governo do Estado do Espírito Santo.</p>
        </div>
    </div>

    <section id="content" class="container">
        <div class="row">
            <div class="col-md-12">
                <form>
                    @if (Model.Count() > 0)
                    {
                        <div class="form-group">
                            <p class="lead">
                                Utilize o campo abaixo para selecionar um orgão, em seguida clique no botão "Visualizar Organograma" para exibir a estrutura organizacional e informações de endereço e contato a opção selecionada.
                            </p>

                            <select id="orgao" class="form-control" placeholder="Selecione um Órgão">
                                <option value="-1">
                                    Selecione um Órgão do Governo do Estado
                                </option>
                                @foreach (var org in Model)
                                {
                                    <option value="@org.Guid">
                                        @org.SiglaNome
                                    </option>
                                }
                            </select>

                        </div>
                        <div class="form-group text-center">
                            <button type="button" data-evento="4" title="Visualizar Organograma" class="btn btn-danger btnModalUnidade"><i class="fa fa-sitemap" aria-hidden="true"></i> Visualizar Organograma</button>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-warning">O usuário não está associado a uma organização.</div>
                    }
                </form>
            </div>
        </div>
    </section>

    @section styles {
        <link href="~/Scripts/OrgChart/jquery.orgchart.min.css" rel="stylesheet" type="text/css" />
        <link href="~/Scripts/OrgChart/orgchartCustom.css" rel="stylesheet" type="text/css" />
    }

    @section scripts{
        <script src="~/Scripts/OrgChart/jquery.orgchart.min.js"></script>
        <script src="~/Scripts/jsPDF/jspdf.min.js"></script>

        <script>
            //Filtro no campo select Orgao
            $(document).ready(function () {
                $("#orgao").select2({
                    width: '100%'
                });

                $.fn.select2.defaults.reset();

            });
        </script>

        <script>
            $('body').on('click', '.btnModalUnidade', function () {

                if ($('#orgao').val() == '-1') {
                    toastr["info"]("Selecione um órgão para visualizar o organograma.");
                    return false;
                }


                var evento = "";

                var url = '@Url.Action("Organograma", "Inicio")' + '?guid=' + $('#orgao').val();                

                if ($(this).attr('title') != "") {
                    evento = $(this).attr('title')
                }
                else {
                    evento = $(this).attr('data-original-title')
                }

                idEvento = $(this).attr('data-evento');

                $.ajax({
                    url: url,
                    global: false,
                    type: 'GET',
                    async: false,
                    success: function (data) {                        

                        let dados = JSON.parse(data);

                        console.log(dados);

                        if (dados != null) {
                            $('#modalTipoUnidadeLabel').text(evento);
                            $('#update').empty();

                            if (idEvento == 4) {
                                $('#update').append('<div class="organogramachart"></div>')
                                organograma('.organogramachart', dados);

                                //Exibe modal full
                                $('.orgchart').parents('.modal-lg').addClass('modal-full');

                                //Evento após exibição modal
                                $('#modalCriar').on('shown.bs.modal', function (e) {
                                    //Centraliza chart
                                    $('.orgchart').css('transform', 'translateX(-' + (($('.orgchart').width() / 2) - ($(window).width() / 2) + (65)) + 'px)');

                                    //Retorna chart para o centro quando todos os filhos são fechados
                                    $('.orgchart .organizacao:first').on('click', '.fa-chevron-up', function () { $('.orgchart').css('transform', ''); });
                                });
                            }
                            else {
                                $('#update').append('<div class="detalhes"></div>')
                                $('.detalhes').append(dados);

                                //Exibe modal tamanho padrão
                                $('.detalhes').parents('.modal-lg').removeClass('modal-full');
                            }

                            $('#modalCriar').modal('show');
                        }
                    },
                    error: function (data) {
                        console.log(data);
                        toastr["warning"]("Não foi possível exibir o organograma solicitado!");
                    }
                });

                return false;
            });

            var organograma = function exibeOrganograma(divContent, dados) {
                $(divContent).orgchart({
                    'data': dados,
                    'depth': 4,
                    'nodeContent': 'title',
                    //'exportButton': true,
                    //'exportFilename': 'Organograma',
                    //'exportFileextension': 'pdf',                    
                    'pan': true,
                    'zoom': true,
                    'nodeID': 'tipo',
                    'toggleSiblingsResp': true,
                    'parentNodeSymbol': 'fa-sitemap',
                    'createNode': function ($node, data) {
                        var secondMenuIcon = $('<i>', {
                            'class': 'second-menu-icon',
                            click: function () {
                                ExibeDetalhes(data.className, data.guid);
                                //$(this).siblings('.second-menu').toggle();
                            }
                        });
                        var secondMenu = '<div class="second-menu"><p>' + data.tipo + '</p></div>';
                        $node.append(secondMenuIcon).append(secondMenu);
                    }
                });
            }


            function ExibeDetalhes(tipo, guid) {
                var url = "";

                if (guid != '' && tipo == 'unidade') {
                    url = '/Inicio/VisualizarUnidade?guid=' + guid;
                }
                else if (guid != '' && tipo == 'organizacao') {
                    url = '/Inicio/VisualizarOrganizacao?guid=' + guid;
                }
                else {
                    return false;
                }

                $.ajax(url)
                    .done(function (dados) {
                        if (dados != null) {
                            $('#update').append('<div class="detalhes"></div>')

                            $('.organogramachart').hide();
                            $('.detalhes').append(dados);
                            $('.detalhes').append('<div id="resultForm" class="form-group text-right"><button type="button" id="btn-voltar" class="btn btn-primary"><i class="fa fa-long-arrow-left" aria-hidden="true"></i> Voltar</button></div>');
                            $('.detalhes').parents('.modal-lg').removeClass('modal-full');
                        }
                    })
                    .fail(function (data) {                        
                        toastr["warning"]("Não foi possível exibir o organograma solicitado!");
                    });
            }

            $('body').on('click', '#btn-voltar', function () {
                $('.organogramachart').show();
                $('.detalhes').hide();

                $('.orgchart').parents('.modal-lg').addClass('modal-full');
            });

        </script>
    }
